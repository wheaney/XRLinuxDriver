#!/usr/bin/env bash

# This setup script should do the minimum work required to download the release package, unzip it, and kick off the
# setup script contained within.

# exit when any command fails
set -e

# Make sure only root can run our script
if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

check_command() {
    if ! command -v "$1" &>/dev/null; then
        echo "Please install \"$1\" and make sure it's available in your \$PATH, then rerun the setup."
        exit 1
    fi
}

check_command "curl"

ARCH=$(uname -m)

# Detect SteamOS for lib archive variant
STEAMOS_SUFFIX=""
if [ -f /etc/os-release ]; then
  . /etc/os-release
  if [ "$ID" == "steamos" ]; then
    STEAMOS_SUFFIX=".steamos"
  fi
fi

start_dir=$(pwd)

# create temp directory
tmp_dir=$(mktemp -d -t xr-driver-XXXXXXXXXX)
pushd $tmp_dir > /dev/null
echo "Created temp directory: ${tmp_dir}"

binary_download_url="https://github.com/wheaney/XRLinuxDriver/releases/latest/download/xrDriver-$ARCH.tar.gz"
lib_download_url="https://github.com/wheaney/XRLinuxDriver/releases/latest/download/xrDriver-libs-$ARCH${STEAMOS_SUFFIX}.tar.gz"
if [ "$1" = "-v" ]
then
  metrics_version="$2"
  binary_path_arg="$3"
  lib_path_arg="$4"
elif [ "$1" = "--tag" ] && [ -n "$2" ]
then
  binary_download_url="https://github.com/wheaney/XRLinuxDriver/releases/download/$2/xrDriver-$ARCH.tar.gz"
  lib_download_url="https://github.com/wheaney/XRLinuxDriver/releases/download/$2/xrDriver-libs-$ARCH${STEAMOS_SUFFIX}.tar.gz"
else
  binary_path_arg="$1"
  lib_path_arg="$2"
fi

if [ -z "$binary_path_arg" ]
then
  # download and unzip the latest driver
  binary_path_arg="xrDriver-$ARCH.tar.gz"
  echo "Downloading to: ${tmp_dir}/$binary_path_arg"

  curl -L "$binary_download_url" > "$binary_path_arg"
else
  if [[ "$binary_path_arg" = /* ]]; then
    abs_path="$binary_path_arg"
  else
    # Convert relative path to absolute path
    abs_path=$(realpath "$start_dir/$binary_path_arg")
  fi
  cp $abs_path $tmp_dir
fi

echo "Extracting to: ${tmp_dir}/xr_driver"
tar -xf $(basename $binary_path_arg)

# Handle lib archive
if [ -z "$lib_path_arg" ]
then
  # download and unzip the latest lib archive
  lib_path_arg="xrDriver-libs-$ARCH${STEAMOS_SUFFIX}.tar.gz"
  echo "Downloading to: ${tmp_dir}/$lib_path_arg"

  curl -L "$lib_download_url" > "$lib_path_arg"
else
  if [[ "$lib_path_arg" = /* ]]; then
    abs_lib_path="$lib_path_arg"
  else
    # Convert relative path to absolute path
    abs_lib_path=$(realpath "$start_dir/$lib_path_arg")
  fi
  cp $abs_lib_path $tmp_dir
fi

echo "Extracting lib to: ${tmp_dir}/xr_driver/lib"
tar -xf $(basename $lib_path_arg)
# Move lib files to xr_driver/lib subdirectory
mkdir -p xr_driver/lib
mv xr_driver_lib/* xr_driver/lib/
rmdir xr_driver_lib

pushd xr_driver > /dev/null

# run the setup script that comes with this release, pass in the metrics version
./setup $metrics_version

echo "Deleting temp directory: ${tmp_dir}"
rm -rf $tmp_dir
cd "$(dirs -l -0)" && dirs -c
