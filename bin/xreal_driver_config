#!/usr/bin/env bash

if [ -n "$1" ]
then
    config_value=""
    if [ "$1" == "--disable" ] || [ "$1" == "-d" ]; then
        config_key="disabled"
        config_value="true"
    elif [ "$1" == "--enable" ] || [ "$1" == "-e" ]; then
        config_key="disabled"
        config_value="false"
    elif [ "$1" == "--status" ] || [ "$1" == "-s" ]; then
        config_key="disabled"
    elif [ "$1" == "--mouse-sensitivity" ] || [ "$1" == "-ms" ]; then
        config_key="mouse_sensitivity"
        config_type="string"
        if [ -n "$2" ]; then
            config_value="$2"
        fi
    elif [ "$1" == "--debug" ]; then
        config_key="debug"
        config_type="string"
        if [ -n "$2" ]; then
            config_value="$2"
        fi
    elif [ "$1" == "--use-joystick" ] || [ "$1" == "-j" ]; then
        config_type="string"
        config_key="output_mode"
        config_value="joystick"
        config_key2="external_mode"
        config_value2="none"
    elif [ "$1" == "--use-mouse" ] || [ "$1" == "-m" ]; then
        config_type="string"
        config_key="output_mode"
        config_value="mouse"
        config_key2="external_mode"
        config_value2="none"
    elif [ "$1" == "--display-zoom" ] || [ "$1" == "-z" ]; then
        config_key="display_zoom"
        config_type="string"
        if [ -n "$2" ]; then
            config_value="$2"
        fi
    elif [ "$1" == "--virtual-display" ] || [ "$1" == "-vd" ]; then
        config_type="string"
        config_key="output_mode"
        config_value="external_only"
        config_key2="external_mode"
        config_value2="virtual_display"
    elif [ "$1" == "--sideview" ] || [ "$1" == "-sv" ]; then
        config_type="string"
        config_key="output_mode"
        config_value="external_only"
        config_key2="external_mode"
        config_value2="sideview"
    elif [ "$1" == "--sbs-mode-stretched" ] || [ "$1" == "-sbsms" ]; then
        config_type="string"
        config_key="sbs_mode_stretched"
        # use $2 if present, otherwise default to "true"
        config_value="${2:-true}"
    elif [ "$1" == "--sbs-content-3d" ] || [ "$1" == "-sbs3d" ]; then
        config_type="string"
        config_key="sbs_content"
        config_value="${2:-true}"
    elif [ "$1" == "--sbs-display-size" ] || [ "$1" == "-sbsds" ]; then
        config_type="string"
        config_key="sbs_display_size"
        config_value="$2"
    elif [ "$1" == "--sbs-display-distance" ] || [ "$1" == "-sbsdd" ]; then
        config_type="string"
        config_key="sbs_display_distance"
        config_value="$2"
    elif [ "$1" == "--sideview-position" ] || [ "$1" == "-svp" ]; then
        config_type="string"
        config_key="sideview_position"
        config_value="$2"
    elif [ "$1" == "--sideview-display-size" ] || [ "$1" == "-svds" ]; then
        config_type="string"
        config_key="sideview_display_size"
        config_value="$2"
    fi

    if [[ -n $config_key ]]; then
        config_file=~/.xreal_driver_config
        touch "$config_file"

        # non-empty config_value implies write/update, empty implies read (report status)
        if [[ -n $config_value ]]; then
            # Check if the key already exists in the config file
            if grep -q "^$config_key=" "$config_file"; then
                # Replace the existing key/value pair
                sed -i "s/^$config_key=.*/$config_key=$config_value/" "$config_file"
            else
                # Add the new key/value pair to the end of the file
                echo "$config_key=$config_value" >> "$config_file"
            fi
            if [[ -n $config_key2 ]]; then
                if grep -q "^$config_key2=" "$config_file"; then
                    sed -i "s/^$config_key2=.*/$config_key2=$config_value2/" "$config_file"
                else
                    echo "$config_key2=$config_value2" >> "$config_file"
                fi
            fi
        else
            if [ "$config_type" == "string" ]; then
              status="Not set"
            else
              status="enabled"
            fi

            while read -r line; do
                if [[ $line == "$config_key="* ]]; then
                    config_value=${line#*=}
                    if [ "$config_type" == "string" ]; then
                      status=$config_value
                    else
                      # Check if the value is "true"
                      if [ "$config_value" == "true" ]; then
                          status="disabled"
                      fi
                    fi

                    break
                fi
            done < "$config_file"

            echo $status
        fi

        exit 0
    fi
fi

echo "Usage: xreal_driver_config [options]
Options:
  -d, --disable
  -e, --enable
  -s, --status
  -j, --use-joystick
  -m, --use-mouse
  -ms, --mouse-sensitivity [sensitivity_value]
  -z, --display-zoom [zoom_value]
  -vd, --virtual-display
  -sv, --sideview
  -svp, --sideview-position [top_left|top_right|bottom_left|bottom_right]
  -svds, --sideview-display-size [display_size]
  -sbsms, --sbs-mode-stretched [true|false]
  -sbs3d, --sbs-content-3d [true|false]
  -sbsds, --sbs-display-size [display_size]
  -sbsdd, --sbs-display-distance [display_distance]"
